##################################
### bbswitch
##################################
# Build Requires:
sudo zypper install gcc make patch m4 binutils dkms kernel-default-devel libelf-devel

git clone https://github.com/Bumblebee-Project/bbswitch

Patch for dkms:
sed -i 's/#MODULE_VERSION#/0.8/g' bbswitch/dkms/dkms.conf

sudo mkdir -p /usr/src/bbswitch-0.8
sudo cp bbswitch/bbswitch.c /usr/src/bbswitch-0.8/
sudo cp bbswitch/Makefile /usr/src/bbswitch-0.8/
sudo cp bbswitch/dkms/dkms.conf /usr/src/bbswitch-0.8/

sudo /usr/sbin/dkms remove -m bbswitch -v 0.8 --all
sudo /usr/sbin/dkms build -m bbswitch -v 0.8 -k $(uname -r)
sudo /usr/sbin/dkms install -m bbswitch -v 0.8 -k $(uname -r)

sudo sh -c 'echo "bbswitch" >> /usr/lib/modules-load.d/bbswitch.conf'
sudo sh -c 'echo "options bbswitch load_state=0 unload_state=1" >> /etc/modprobe.d/50-bbswitch.conf'

##################################
### primus
##################################
# Build Requires:
sudo zypper install gcc gcc-c++ glibc-devel Mesa-libGL-devel libX11-devel libstdc++-devel
sudo zypper install gcc-32bit gcc-c++-32bit glibc-devel-32bit libX11-devel-32bit libstdc++-devel-32bit

# PKG Depends:
sudo zypper install Mesa-dri Mesa-libGL1 glibc libX11-6 libstdc++6
sudo zypper install Mesa-dri-32bit Mesa-libGL1-32bit glibc-32bit libX11-6-32bit libstdc++6-32bit

git clone https://github.com/amonakov/primus

# Patch for openSUSE :
sed -i 's/# export PRIMUS_SYNC/export PRIMUS_SYNC/g' primus/primusrun
sed -i 's/# export PRIMUS_VERBOSE/export PRIMUS_VERBOSE/g' primus/primusrun
sed -i 's/# export PRIMUS_UPLOAD/export PRIMUS_UPLOAD/g' primus/primusrun
sed -i 's/# export PRIMUS_SLEEP/export PRIMUS_SLEEP/g' primus/primusrun
sed -i 's/# export PRIMUS_DISPLAY/export PRIMUS_DISPLAY/g' primus/primusrun
sed -i 's/# export PRIMUS_libGLa/export PRIMUS_libGLa/g' primus/primusrun
sed -i 's/# export PRIMUS_libGLd/export PRIMUS_libGLd/g' primus/primusrun
sed -i 's/$(dirname.*/'"'\/usr\/\$LIB\/primus'"'}/g' primus/primusrun

cd primus

LIBDIR=lib64 make
sudo install -D -m755 "primusrun" "/usr/bin/primusrun"
sudo install -D -m755 "lib64/libGL.so.1" "/usr/lib64/primus/libGL.so.1"
make clean

export CC="gcc -m32"
export CXX="g++ -m32"
LIBDIR=lib32 make
sudo install -D -m755 "lib/libGL.so.1" "/usr/lib/primus/libGL.so.1"

##################################
### bumblebee
##################################
# Build Requires:
sudo zypper install glib2-devel help2man pciutils pkg-config pwdutils xorg-x11-libX11-devel automake autoconf

# PKG Depends:
sudo zypper install glibc libglib-2 libX11-6 pciutils pwdutils xorg-x11-libX11

git clone https://github.com/Bumblebee-Project/Bumblebee

# PATCH:
# decimal-pciid patch
sed -i 's/02x/02d/g' Bumblebee/src/bbsecondary.c

# nvidia-uvm-modeset drm support
wget https://raw.githubusercontent.com/Mint-Fans/linux-package/SUSE/nvidia-uvm-modeset-drm-support.patch
patch -p0 -i nvidia-uvm-modeset-drm-support.patch

cd Bumblebee
autoreconf -fi
./configure \
  --prefix=/usr \
  --sysconfdir=/etc \
  --without-pidfile \
  --with-udev-rules=/usr/lib/udev/rules.d/ \
  CONF_DRIVER_MODULE_NVIDIA=nvidia \
  CONF_LDPATH_NVIDIA=/usr/lib64/nvidia:/usr/lib/nvidia \
  CONF_MODPATH_NVIDIA=/usr/lib64/nvidia/xorg/,/usr/lib64/xorg/modules \
  CONF_PRIMUS_LD_PATH=/usr/lib64/primus:/usr/lib/primus

make
sudo make install

sudo install -D -m644 "scripts/systemd/bumblebeed.service" "/usr/lib/systemd/system/bumblebeed.service"
sudo ln -s /usr/sbin/service /usr/sbin/rcbumblebeed
sudo sed -i '3i After=dkms.service systemd-modules-load.service' /systemd/system/bumblebeed.service

sudo groupadd -r bumblebee
sudo gpasswd -a $USER bumblebee
sudo gpasswd -a $USER video

sudo sh -c 'echo "blacklist nouveau" > /etc/modprobe.d/50-blacklist.conf'
sudo sh -c 'echo "blacklist nvidia" >> /etc/modprobe.d/50-blacklist.conf'

sudo sed -i 's/Exec=.*/Exec=sudo optirun -b none nvidia-settings -c :8/g' /usr/share/applications/nvidia-settings.desktop

sudo systemctl enable bumblebeed.service

sudo dracut -f -v
