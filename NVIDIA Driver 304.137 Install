###########################################
### NVIDIA Driver 304.137 Install
###########################################
# Debian
LIB=lib
LIB64=lib/x86_64-linux-gnu
LIB32=lib/i386-linux-gnu

# Fedora /openSUSE
LIB=lib64
LIB64=lib64
LIB32=lib

# Debian Depends:
sudo apt-get install dkms gcc make patch linux-headers-amd64

# openSUSE Depends:
sudo zypper install dkms gcc make patch binutils gtk3 kernel-default-devel libelf-devel

# Fedora Depends:
sudo dnf install dkms gcc make patch glibc-devel kernel-devel elfutils-libelf-devel pangox-compat selinux-policy-devel

NV_NAME=NVIDIA-Linux-x86_64
NV_VER='304.137'

wget -c http://us.download.nvidia.com/XFree86/Linux-x86_64/$NV_VER/"$NV_NAME"-"$NV_VER".run

sh "$NV_NAME"-"$NV_VER".run -x

sudo /sbin/rmmod nvidia >/dev/null 2>&1

###########################################
### NVIDIA Driver 64-bit Library Install
###########################################
## Install library
cd "$NV_NAME"-"$NV_VER"

# X driver
sudo install -D -m755 nvidia_drv.so /usr/$LIB/xorg/modules/drivers/nvidia_drv.so

# GLX extension module for X
sudo install -D -m755 "libglx.so.$NV_VER" /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so.$NV_VER
sudo ln -sf libglx.so.$NV_VER /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so.1
sudo ln -sf libglx.so.1 /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so

# OpenGL library
sudo install -D -m755 "libGL.so.$NV_VER" /usr/$LIB64/nvidia/libGL.so.$NV_VER
sudo ln -sf libGL.so.$NV_VER /usr/$LIB64/nvidia/libGL.so.1
sudo ln -sf libGL.so.1 /usr/$LIB64/nvidia/libGL.so

# OpenGL core library
sudo install -D -m755 "libnvidia-glcore.so.$NV_VER" /usr/$LIB64/libnvidia-glcore.so.$NV_VER

# VDPAU
sudo install -D -m755 "libvdpau_nvidia.so.$NV_VER" /usr/$LIB64/vdpau/libvdpau_nvidia.so.$NV_VER
sudo ln -sf libvdpau_nvidia.so.$NV_VER /usr/$LIB64/vdpau/libvdpau_nvidia.so.1
sudo ln -sf libvdpau_nvidia.so.1 /usr/$LIB64/vdpau/libvdpau_nvidia.so

# CUDA
sudo install -D -m755 "libcuda.so.$NV_VER" /usr/$LIB64/libcuda.so.$NV_VER
sudo ln -sf libcuda.so.$NV_VER /usr/$LIB64/libcuda.so
sudo install -D -m755 "libnvcuvid.so.$NV_VER" /usr/$LIB64/libnvcuvid.so.$NV_VER
sudo ln -sf libnvcuvid.so.$NV_VER /usr/$LIB64/libnvcuvid.so.1

# nvidia-tls library
sudo install -D -m755 "tls/libnvidia-tls.so.$NV_VER" /usr/$LIB64/libnvidia-tls.so.$NV_VER
sudo install -D -m755 "libnvidia-cfg.so.$NV_VER" /usr/$LIB64/libnvidia-cfg.so.$NV_VER
sudo ln -sf libnvidia-cfg.so.$NV_VER /usr/$LIB64/libnvidia-cfg.so.1
sudo install -D -m755 "libnvidia-ml.so.$NV_VER" /usr/$LIB64/libnvidia-ml.so.$NV_VER
sudo ln -sf libnvidia-ml.so.$NV_VER /usr/$LIB64/libnvidia-ml.so

# OpenCL
sudo install -D -m644  nvidia.icd "/etc/OpenCL/vendors/nvidia.icd"
sudo install -D -m755 "libnvidia-compiler.so.$NV_VER" "/usr/$LIB64/libnvidia-compiler.so.$NV_VER"
sudo install -D -m755 "libnvidia-opencl.so.$NV_VER" "/usr/$LIB64/libnvidia-opencl.so.$NV_VER"
sudo ln -sf libnvidia-opencl.so.$NV_VER "/usr/$LIB64/libnvidia-opencl.so"
sudo install -D -m755 "libOpenCL.so.1.0.0" "/usr/$LIB64/nvidia/libOpenCL.so.1.0.0"
sudo ln -sf "libOpenCL.so.1.0.0" "/usr/$LIB64/nvidia/libOpenCL.so"

# libXvMCNVIDIA
sudo install -D -m755 "libXvMCNVIDIA.so.$NV_VER" /usr/$LIB/nvidia/libXvMCNVIDIA.so.$NV_VER
sudo ln -sf libXvMCNVIDIA.so.$NV_VER /usr/$LIB/nvidia/libXvMCNVIDIA.so.1
sudo ln -sf libXvMCNVIDIA.so.1 /usr/$LIB/nvidia/libXvMCNVIDIA.so

# nvidia-wfb
sudo install -D -m755 libnvidia-wfb.so.$NV_VER /usr/$LIB/nvidia/xorg/modules/libnvidia-wfb.so.$NV_VER
sudo ln -sf libnvidia-wfb.so.$NV_VER /usr/$LIB/nvidia/xorg/modules/libnvidia-wfb.so

# nvidia-settings
sudo install -D -m755 nvidia-settings /usr/bin/nvidia-settings
sudo install -D -m644 nvidia-settings.1.gz /usr/share/man/man1/nvidia-settings.1.gz
sudo install -D -m644 nvidia-settings.desktop /usr/share/applications/nvidia-settings.desktop
sudo install -D -m644 nvidia-settings.png /usr/share/pixmaps/nvidia-settings.png
sudo sed -e 's:__UTILS_PATH__:/usr/bin:' -e 's:__PIXMAP_PATH__:/usr/share/pixmaps:' -i "/usr/share/applications/nvidia-settings.desktop"

# nvidia-xconfig
sudo install -D -m755 nvidia-xconfig /usr/bin/nvidia-xconfig
sudo install -D -m644 nvidia-xconfig.1.gz /usr/share/man/man1/nvidia-xconfig.1.gz

# nvidia-smi
sudo install -D -m755 nvidia-smi /usr/bin/nvidia-smi
sudo install -D -m644 nvidia-smi.1.gz /usr/share/man/man1/nvidia-smi.1.gz

# nvidia-bug-report
sudo install -D -m755 nvidia-bug-report.sh /usr/bin/nvidia-bug-report.sh

# CUDA Proxy
sudo install -D -m755 nvidia-cuda-proxy-control /usr/bin/nvidia-cuda-proxy-control
sudo install -D -m755 nvidia-cuda-proxy-server /usr/bin/nvidia-cuda-proxy-server
sudo install -D -m644 nvidia-cuda-proxy-control.1.gz /usr/share/man/man1/nvidia-cuda-proxy-control.1.gz

# Documentation
sudo install -D -m644 LICENSE /usr/share/licenses/nvidia/LICENSE
sudo install -D -m644 README.txt /usr/share/doc/nvidia/README
sudo install -D -m644 NVIDIA_Changelog /usr/share/doc/nvidia/NVIDIA_Changelog

# Link to libwfb.so
# sudo ln -sf /usr/$LIB/xorg/modules/libwfb.so /usr/$LIB/nvidia/xorg/modules/libwfb.so

###########################################
### NVIDIA Driver 32-bit Library Install
###########################################
# OpenGL library
sudo install -D -m755 32/libGL.so.$NV_VER /usr/$LIB32/nvidia/libGL.so.$NV_VER
sudo ln -sf libGL.so.$NV_VER /usr/$LIB32/nvidia/libGL.so.1
sudo ln -sf libGL.so.1 /usr/$LIB32/nvidia/libGL.so

# OpenGL core library
sudo install -D -m755 32/libnvidia-glcore.so.$NV_VER /usr/$LIB32/libnvidia-glcore.so.$NV_VER

# VDPAU
sudo install -D -m755 32/libvdpau_nvidia.so.$NV_VER /usr/$LIB32/vdpau/libvdpau_nvidia.so.$NV_VER
sudo ln -sf libvdpau_nvidia.so.$NV_VER /usr/$LIB32/vdpau/libvdpau_nvidia.so.1
sudo ln -sf libvdpau_nvidia.so.1 /usr/$LIB32/vdpau/libvdpau_nvidia.so

# CUDA
sudo install -D -m755 32/libcuda.so.$NV_VER /usr/$LIB32/libcuda.so.$NV_VER
sudo ln -sf libcuda.so.$NV_VER /usr/$LIB32/libcuda.so

# OpenCL
sudo install -D -m755 32/libnvidia-compiler.so.$NV_VER /usr/$LIB32/libnvidia-compiler.so.$NV_VER
sudo install -D -m755 32/libnvidia-opencl.so.$NV_VER /usr/$LIB32/libnvidia-opencl.so.$NV_VER
sudo install -D -m755 32/libnvidia-ml.so.$NV_VER /usr/$LIB32/libnvidia-ml.so.$NV_VER
sudo install -D -m755 32/libOpenCL.so.1.0.0 /usr/$LIB32/nvidia/libOpenCL.so.1.0.0
sudo ln -sf /usr/$LIB32/nvidia/libOpenCL.so.1.0.0 /usr/$LIB32/nvidia/libOpenCL.so

# nvidia-tls library
sudo install -D -m755 32/tls/libnvidia-tls.so.$NV_VER /usr/$LIB32/libnvidia-tls.so.$NV_VER

sudo /sbin/ldconfig

############################################
### Install dkms sources
############################################
# Debian Depends:
sudo apt-get install dkms gcc make patch linux-headers-amd64

# openSUSE Depends:
sudo zypper install dkms gcc make patch binutils gtk3 kernel-default-devel libelf-devel

# Fedora Depends:
sudo dnf install dkms gcc make patch glibc-devel kernel-devel elfutils-libelf-devel pangox-compat selinux-policy-devel

# Remove dkms sources
sudo rm -rf /usr/src/nvidia-$NV_VER

# patch dkms sources
cp LICENSE kernel/
cp README.txt kernel/
echo "nvidia.ko external" > kernel/Module.supported

cat > kernel/dkms.conf << EOF
# DKMS
PACKAGE_NAME="nvidia"
PACKAGE_VERSION="$NV_VER"
BUILT_MODULE_NAME[0]=nvidia
DEST_MODULE_LOCATION[0]="/updates"
MAKE[0]="unset ARCH; IGNORE_CC_MISMATCH=1 env NV_VERBOSE=1 make \${parallel_jobs+-j\$parallel_jobs} module KERNEL_UNAME=\${kernelver}"
CLEAN="make KERNEL_UNAME=\${kernelver} clean"
AUTOINSTALL="yes"
EOF

# patch for linux 4.3 - 4.15
wget https://github.com/Mint-Fans/linux-package/raw/NVIDIA/nvidia-304-KMS-Patch.tar.xz
tar Jxvf nvidia-304-KMS-Patch.tar.xz
mv kernel b
patch -p0 -i patches/disable-mtrr.patch
patch -p0 -i patches/pud-offset.patch
patch -p0 -i patches/nvidia-drm-pci-init.patch
patch -p0 -i patches/timer.patch
mv b kernel

# copy dkms sources
sudo cp -R kernel /usr/src/nvidia-"$NV_VER"

# Install Kernel Modules
sudo /usr/sbin/dkms remove -m nvidia -v "$NV_VER" --all
sudo /usr/sbin/dkms build -m nvidia -v $NV_VER -k $(uname -r)
sudo /usr/sbin/dkms install -m nvidia -v $NV_VER -k $(uname -r)

sudo sh -c 'echo "blacklist nouveau" > /etc/modprobe.d/50-blacklist.conf'

# Debian
sudo update-initramfs -u

# Fedora /openSUSE
sudo dracut -f -v

