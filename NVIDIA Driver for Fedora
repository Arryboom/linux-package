############################################
### NVIDIA Driver 64-bit Library
############################################
# openSUSE Depends:
sudo zypper install dkms gcc make patch binutils gtk3 kernel-default-devel libelf-devel

# Fedora Depends:
sudo dnf install dkms gcc make patch glibc-devel kernel-devel elfutils-libelf-devel pangox-compat selinux-policy-devel

LIB=lib64
NV_NAME=NVIDIA-Linux-x86_64
NV_VER='390.42'

wget -c http://us.download.nvidia.com/XFree86/Linux-x86_64/$NV_VER/"$NV_NAME"-"$NV_VER".run

sh "$NV_NAME"-"$NV_VER".run --check

sh "$NV_NAME"-"$NV_VER".run -x

sudo /sbin/rmmod nvidia >/dev/null 2>&1

## Remove all files
sudo rm -f /usr/$LIB/xorg/modules/drivers/nvidia_drv.so
sudo rm -f /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so.$NV_VER
sudo rm -f /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so"
sudo rm -f /usr/$LIB/nvidia/libGL.so.$NV_VER
sudo rm -f /usr/$LIB/nvidia/libGL.so.1
sudo rm -f /usr/$LIB/libnvidia-glcore.so.$NV_VER
sudo rm -f /usr/$LIB/vdpau/libvdpau_nvidia.so.$NV_VER
sudo rm -f /usr/$LIB/vdpau/libvdpau_nvidia.so.1
sudo rm -f /usr/$LIB/libnvidia-tls.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-cfg.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-cfg.so.1
sudo rm -f /usr/$LIB/libnvidia-ml.so.$NV_VER
sudo rm -f /usr/$LIB/libcuda.so.$NV_VER
sudo rm -f /usr/$LIB/libnvcuvid.so.$NV_VER
sudo rm -f /usr/$LIB/libnvcuvid.so.1
sudo rm -f /usr/$LIB/libnvidia-ptxjitcompiler.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-ptxjitcompiler.so.1
sudo rm -f /usr/$LIB/libnvidia-fatbinaryloader.so.$NV_VER
sudo rm -f /usr/bin/nvidia-xconfig
sudo rm -f /usr/share/man/man1/nvidia-xconfig.1.gz
sudo rm -f /usr/bin/nvidia-settings
sudo rm -f /usr/$LIB/nvidia/libnvidia-gtk3.so.$NV_VER
sudo rm -f /usr/share/nvidia/nvidia-application-profiles-"$NV_VER"-key-documentation"
sudo rm -f /usr/share/man/man1/nvidia-settings.1.gz
sudo rm -f /usr/share/applications/nvidia-settings.desktop
sudo rm -f /usr/share/pixmaps/nvidia-settings.png
sudo rm -f /usr/bin/nvidia-bug-report.sh
sudo rm -f /usr/bin/nvidia-smi
sudo rm -f /usr/share/man/man1/nvidia-smi.1.gz
sudo rm -f /etc/OpenCL/vendors/nvidia.icd
sudo rm -f /usr/$LIB/libnvidia-compiler.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-opencl.so.$NV_VER
sudo rm -f /usr/$LIB/nvidia/libOpenCL.so.1.0.0
sudo rm -f /usr/$LIB/nvidia/libOpenCL.so
sudo rm -f /usr/share/licenses/nvidia/LICENSE
sudo rm -f /usr/share/licenses/nvidia-utils
sudo rm -f /usr/share/doc/nvidia/README
sudo rm -f /usr/share/doc/nvidia/NVIDIA_Changelog
sudo rm -f /usr/share/doc/nvidia-utils
sudo rm -f /usr/$LIB/nvidia/xorg/modules/libwfb.so

# Remove the sources
sudo rm -rf /usr/src/nvidia-$NV_VER

# Install dkms sources
sudo cp -R "$NV_NAME"-"$NV_VER"/kernel /usr/src/nvidia-"$NV_VER"
sudo cp "$NV_NAME"-"$NV_VER"/LICENSE /usr/src/nvidia-"$NV_VER"/
sudo cp "$NV_NAME"-"$NV_VER"/README.txt /usr/src/nvidia-"$NV_VER"/

# Copy patches to dkms
# mkdir -p /usr/src/nvidia-"$NV_VER"/patches
# cp /usr/share/doc/packages/nvidia-bumblebee/*.patch /usr/src/nvidia-"$NV_VER"/patches/

# Patch makefile for x86_64 systems
# %ifarch x86_64
# sed '34 c\ARCH = x86_64' Makefile > mk1
# mv mk1 Makefile
# %endif

echo "nvidia.ko external" > Module.supported
sudo mv Module.supported /usr/src/nvidia-"$NV_VER"/

cat > dkms.conf << EOF
PACKAGE_NAME=nvidia
PACKAGE_VERSION=$NV_VER
BUILT_MODULE_NAME[0]=nvidia
DEST_MODULE_LOCATION[0]="/updates/"
MAKE[0]="'make' KERNEL_UNAME=\${kernelver} modules"
CLEAN="make clean"
AUTOINSTALL="yes"
BUILT_MODULE_NAME[1]="nvidia-uvm"
DEST_MODULE_LOCATION[1]="/updates/"
BUILT_MODULE_NAME[2]="nvidia-drm"
DEST_MODULE_LOCATION[2]="/updates/"
BUILT_MODULE_NAME[3]="nvidia-modeset"
DEST_MODULE_LOCATION[3]="/updates/"
EOF

sudo rm -f /usr/src/nvidia-"$NV_VER"/dkms.conf
sudo mv dkms.conf /usr/src/nvidia-"$NV_VER"/

# Install library
cd "$NV_NAME"-"$NV_VER"

# X driver
sudo install -D -m755  nvidia_drv.so /usr/$LIB/xorg/modules/drivers/nvidia_drv.so

# GLX extension module for X
sudo install -D -m755 "libglx.so.$NV_VER" /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so.$NV_VER

# OpenGL library
sudo install -D -m755 "libGL.so.$NV_VER" /usr/$LIB/nvidia/libGL.so.$NV_VER

# OpenGL core library
sudo install -D -m755 "libnvidia-glcore.so.$NV_VER" /usr/$LIB/libnvidia-glcore.so.$NV_VER

# VDPAU
sudo install -D -m755 "libvdpau_nvidia.so.$NV_VER" /usr/$LIB/vdpau/libvdpau_nvidia.so.$NV_VER
sudo ln -sf libvdpau_nvidia.so.$NV_VER /usr/$LIB/vdpau/libvdpau_nvidia.so.1

# nvidia-tls library
sudo install -D -m755 "tls/libnvidia-tls.so.$NV_VER" /usr/$LIB/libnvidia-tls.so.$NV_VER
sudo install -D -m755 "libnvidia-cfg.so.$NV_VER" /usr/$LIB/libnvidia-cfg.so.$NV_VER
sudo ln -sf libnvidia-cfg.so.$NV_VER /usr/$LIB/libnvidia-cfg.so.1
sudo install -D -m755 "libnvidia-ml.so.$NV_VER" /usr/$LIB/libnvidia-ml.so.$NV_VER
sudo ln -sf libnvidia-ml.so.$NV_VER /usr/$LIB/libnvidia-ml.so

# CUDA
sudo install -D -m755 "libcuda.so.$NV_VER" /usr/$LIB/libcuda.so.$NV_VER
sudo ln -sf libcuda.so.$NV_VER /usr/$LIB/libcuda.so
sudo install -D -m755 "libnvcuvid.so.$NV_VER" /usr/$LIB/libnvcuvid.so.$NV_VER
sudo ln -sf libnvcuvid.so.$NV_VER /usr/$LIB/libnvcuvid.so.1
sudo install -D -m755 "libnvidia-ptxjitcompiler.so.$NV_VER" /usr/$LIB/libnvidia-ptxjitcompiler.so.$NV_VER
sudo ln -sf libnvidia-ptxjitcompiler.so.$NV_VER /usr/$LIB/libnvidia-ptxjitcompiler.so.1

# NVIDIA FAT binary loader library
sudo install -D -m755 "libnvidia-fatbinaryloader.so.$NV_VER" /usr/$LIB/libnvidia-fatbinaryloader.so.$NV_VER

# nvidia-xconfig
sudo install -D -m755 nvidia-xconfig /usr/bin/nvidia-xconfig
sudo install -D -m644 nvidia-xconfig.1.gz /usr/share/man/man1/nvidia-xconfig.1.gz

# nvidia-settings
sudo install -D -m755 nvidia-settings /usr/bin/nvidia-settings
sudo install -D -m644 nvidia-settings.1.gz /usr/share/man/man1/nvidia-settings.1.gz
sudo install -D -m644 nvidia-settings.desktop /usr/share/applications/nvidia-settings.desktop
sudo install -D -m644 nvidia-settings.png /usr/share/pixmaps/nvidia-settings.png
sudo install -D -m755 "libnvidia-gtk3.so.$NV_VER" /usr/$LIB/nvidia/libnvidia-gtk3.so.$NV_VER
sudo install -D -m644 "nvidia-application-profiles-$NV_VER-key-documentation" /usr/share/nvidia/nvidia-application-profiles-$NV_VER-key-documentation
sudo sed -e 's:__UTILS_PATH__:/usr/bin:' -e 's:__PIXMAP_PATH__:/usr/share/pixmaps:' -i "/usr/share/applications/nvidia-settings.desktop"

# nvidia-bug-report
sudo install -D -m755 nvidia-bug-report.sh /usr/bin/nvidia-bug-report.sh

# nvidia-smi
sudo install -D -m755 nvidia-smi /usr/bin/nvidia-smi
sudo install -D -m644 nvidia-smi.1.gz /usr/share/man/man1/nvidia-smi.1.gz

# OpenCL
sudo install -D -m644  nvidia.icd "/etc/OpenCL/vendors/nvidia.icd"
sudo install -D -m755 "libnvidia-compiler.so.$NV_VER" "/usr/$LIB/libnvidia-compiler.so.$NV_VER"
sudo install -D -m755 "libnvidia-opencl.so.$NV_VER" "/usr/$LIB/libnvidia-opencl.so.$NV_VER"
sudo ln -sf libnvidia-opencl.so.$NV_VER /usr/$LIB/libnvidia-opencl.so
sudo install -D -m755 "libOpenCL.so.1.0.0" "/usr/$LIB/nvidia/libOpenCL.so.1.0.0"

# Links to OpenCL
sudo ln -sf "/usr/${LIB}/nvidia/libOpenCL.so.1.0.0" "/usr/${LIB}/nvidia/libOpenCL.so"

# Documentation
sudo install -D -m644 LICENSE /usr/share/licenses/nvidia/LICENSE
sudo ln -s nvidia /usr/share/licenses/nvidia-utils
sudo install -D -m644 README.txt /usr/share/doc/nvidia/README
sudo install -D -m644 NVIDIA_Changelog /usr/share/doc/nvidia/NVIDIA_Changelog
sudo ln -sf nvidia /usr/share/doc/nvidia-utils

# Link to libwfb.so
sudo ln -sf /usr/$LIB/xorg/modules/libwfb.so /usr/$LIB/nvidia/xorg/modules/libwfb.so

# Link to libglx.so otherwise X dont find them
sudo ln -sf /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so.$NV_VER /usr/$LIB/nvidia/xorg/modules/extensions/libglx.so

# Link to libGL
sudo ln -sf /usr/$LIB/nvidia/libGL.so.$NV_VER /usr/$LIB/nvidia/libGL.so.1

# Install dkms
sudo /usr/sbin/dkms remove -m nvidia -v "$NV_VER" --all

export IGNORE_CC_MISMATCH=1
sudo /usr/sbin/dkms build -m nvidia -v $NV_VER
sudo /usr/sbin/dkms install -m nvidia -v $NV_VER

############################################
### NVIDIA Driver 32-bit Library
############################################
# openSUSE Depends:
sudo zypper install Mesa-libGL1-32bit

# Fedora Depends:
sudo dnf install mesa-libGL.i686

LIB=lib

# Remove all files
sudo rm -f /usr/$LIB/nvidia/libGL.so.$NV_VER
sudo rm -f /usr/$LIB/nvidia/libGL.so
sudo rm -f /usr/$LIB/nvidia/libGL.so.1
sudo rm -f /usr/$LIB/libnvidia-glcore.so.$NV_VER
sudo rm -f /usr/$LIB/vdpau/libvdpau_nvidia.so.$NV_VER
sudo rm -f /usr/$LIB/vdpau/libvdpau_nvidia.so.1
sudo rm -f /usr/$LIB/libcuda.so.$NV_VER
sudo rm -f /usr/$LIB/libnvcuvid.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-ptxjitcompiler.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-fatbinaryloader.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-tls.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-compiler.so.$NV_VER
sudo rm -f /usr/$LIB/libnvidia-opencl.so.$NV_VER
sudo rm -f /usr/$LIB/nvidia/libOpenCL.so.1.0.0
sudo rm -f /usr/$LIB/nvidia/libOpenCL.so
sudo rm -f /usr/$LIB/libnvidia-ml.so.$NV_VER

sudo /sbin/ldconfig

# Install library
# OpenGL library
sudo install -D -m755 32/libGL.so.$NV_VER /usr/$LIB/nvidia/libGL.so.$NV_VER

# OpenGL Links
sudo ln -sf /usr/$LIB/nvidia/libGL.so.$NV_VER /usr/$LIB/nvidia/libGL.so
sudo ln -sf /usr/$LIB/nvidia/libGL.so.$NV_VER /usr/$LIB/nvidia/libGL.so.1

# OpenGL core library
sudo install -D -m755 32/libnvidia-glcore.so.$NV_VER /usr/$LIB/libnvidia-glcore.so.$NV_VER

# VDPAU
sudo install -D -m755 32/libvdpau_nvidia.so.$NV_VER /usr/$LIB/vdpau/libvdpau_nvidia.so.$NV_VER
# sudo ln -sf libvdpau_nvidia.so.$NV_VER /usr/$LIB/vdpau/libvdpau_nvidia.so.1

# CUDA
sudo install -D -m755 32/libcuda.so.$NV_VER /usr/$LIB/libcuda.so.$NV_VER
sudo install -D -m755 32/libnvcuvid.so.$NV_VER /usr/$LIB/libnvcuvid.so.$NV_VER
sudo install -D -m755 32/libnvidia-ptxjitcompiler.so.$NV_VER /usr/$LIB/libnvidia-ptxjitcompiler.so.$NV_VER

# NVIDIA FAT binary loader library
sudo install -D -m755 32/libnvidia-fatbinaryloader.so.$NV_VER /usr/$LIB/libnvidia-fatbinaryloader.so.$NV_VER

# nvidia-tls library
sudo install -D -m755 32/tls/libnvidia-tls.so.$NV_VER /usr/$LIB/libnvidia-tls.so.$NV_VER

# OpenCL
sudo install -D -m755 32/libnvidia-compiler.so.$NV_VER /usr/$LIB/libnvidia-compiler.so.$NV_VER
sudo install -D -m755 32/libnvidia-opencl.so.$NV_VER /usr/$LIB/libnvidia-opencl.so.$NV_VER
sudo install -D -m755 32/libnvidia-ml.so.$NV_VER /usr/$LIB/libnvidia-ml.so.$NV_VER
sudo install -D -m755 32/libOpenCL.so.1.0.0 /usr/$LIB/nvidia/libOpenCL.so.1.0.0

# Links
sudo ln -sf /usr/$LIB/nvidia/libOpenCL.so.1.0.0 /usr/$LIB/nvidia/libOpenCL.so

sudo /sbin/ldconfig

# clean
cd ..
sudo rm -rf "$NV_NAME"-"$NV_VER".run
sudo rm -rf "$NV_NAME"-"$NV_VER"

sudo sh -c 'echo "blacklist nouveau" > /etc/modprobe.d/50-blacklist.conf'
sudo dracut -f -v
